<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>图片压缩 & 格式转换工具</title>
<link rel="icon" href="favicon.ico" type="image/x-icon">
<style>
    *{box-sizing:border-box;margin:0;padding:0;font-family:"Microsoft YaHei",sans-serif;}
    body{background:#f0f2f5;padding:20px;color:#333;}
    h2{margin-bottom:10px;font-size:20px;}
    .card{
        background:white;padding:18px;margin-bottom:20px;border-radius:12px;
        box-shadow:0 2px 10px rgba(0,0,0,0.1);
    }
    .preview-area{
        display:flex;flex-wrap:wrap;gap:15px;margin-top:10px;
    }
    .item-card{
        width:260px;background:#fff;border-radius:10px;
        box-shadow:0 2px 6px rgba(0,0,0,0.08);padding:12px;
    }
    .thumb{
        width:100%;height:180px;object-fit:cover;border-radius:8px;background:#eee;
    }
    .controls label{font-size:14px;margin-right:12px;}
    .small{color:#666;font-size:12px;}
    button{
        padding:10px 20px;border:none;border-radius:6px;
        background:#1677ff;color:white;cursor:pointer;margin-top:10px;
    }
    button:hover{opacity:.9}
    select,input[type="number"]{padding:4px 6px;font-size:14px;}
</style>
<script src="jszip.min.js"></script>
<script src="browser-image-compression.js"></script>
</head>

<body>

<!-- 上传区 -->
<div class="card">
    <h2>上传图片</h2>
    <input id="fileInput" type="file" accept="image/*" multiple>
</div>

<!-- 参数设置区 -->
<div class="card">
    <h2>参数设置</h2>
    <div class="controls">
        <label><input id="enableCompress" type="checkbox"> 压缩图片（默认不压缩）</label>

        <label>最大宽度：<input id="maxWidth" type="number" value="1920" style="width:70px;"> px</label>

        <label>输出格式：
            <select id="formatSelect">
                <option value="original">保持原格式</option>
                <option value="jpeg">JPEG</option>
                <option value="png">PNG</option>
                <option value="webp">WebP</option>
            </select>
        </label>

        <label>输出质量：<input id="quality" type="number" min="0" max="1" step="0.05" value="0.9" style="width:60px;"></label>
    </div>
</div>

<!-- 操作按钮 -->
<div class="card">
    <button id="startBtn">开始处理</button>
    <button id="downloadAllBtn">下载全部</button>
</div>

<!-- 预览区 -->
<div class="card">
    <h2>处理结果</h2>
    <div id="preview" class="preview-area"></div>
</div>

<script>
let selectedFiles = [];
const fileInput = document.getElementById("fileInput");
const previewArea = document.getElementById("preview");

fileInput.addEventListener("change", e => {
    selectedFiles = Array.from(e.target.files);
    renderPreview();
});

function renderPreview() {
    previewArea.innerHTML = "";
    selectedFiles.forEach((file, idx) => {
        const url = URL.createObjectURL(file);
        const div = document.createElement("div");
        div.className = "item-card";
        div.innerHTML = `
            <img src="${url}" class="thumb">
            <div class="small">原图：${(file.size/1024).toFixed(1)} KB</div>
            <div class="small" id="after_${idx}">未处理</div>
            <button onclick="downloadSingle(${idx})">下载</button>
        `;
        previewArea.appendChild(div);
    });
}

let processedBlobs = [];

async function processImages() {
    if (!selectedFiles.length) return alert("请先上传图片");

    processedBlobs = [];

    const enableCompress = document.getElementById("enableCompress").checked;
    const maxWidth = parseInt(document.getElementById("maxWidth").value);
    const quality = parseFloat(document.getElementById("quality").value);
    const format = document.getElementById("formatSelect").value;

    for (let i = 0; i < selectedFiles.length; i++) {
        const file = selectedFiles[i];

        let outputBlob;

        if (enableCompress) {
            // ================================
            // ✔ 启用压缩：使用 image-compression
            // ================================
            const options = {
                maxWidthOrHeight: maxWidth,
                initialQuality: quality,
                fileType: format === "original" ? file.type : "image/" + format
            };

            outputBlob = await imageCompression(file, options);

        } else {
            // ================================
            // ✔ 不压缩：只进行格式转换
            // ================================
            const bitmap = await createImageBitmap(file);
            const canvas = document.createElement("canvas");
            canvas.width = bitmap.width;
            canvas.height = bitmap.height;
            const ctx = canvas.getContext("2d");
            ctx.drawImage(bitmap, 0, 0);

            let outType;
            if (format === "original") outType = file.type;
            else outType = "image/" + format;

            outputBlob = await new Promise(resolve =>
                canvas.toBlob(resolve, outType, quality)
            );
        }

        processedBlobs[i] = outputBlob;

        // 显示结果
        const before = file.size;
        const after = outputBlob.size;

        const info = document.getElementById("after_" + i);
        if (enableCompress) {
            info.innerHTML = `压缩后：${(after/1024).toFixed(1)} KB<br>
                <span class="small">节省 ${(1 - after/before)*100 | 0}%</span>`;
        } else {
            info.innerHTML = `转换后：${(after/1024).toFixed(1)} KB`;
        }
    }

    alert("处理完成！");
}

document.getElementById("startBtn").onclick = processImages;

function downloadSingle(idx) {
    if (!processedBlobs[idx]) return alert("请先点击 开始处理");

    const a = document.createElement("a");
    a.href = URL.createObjectURL(processedBlobs[idx]);
    a.download = "image_" + (idx+1) + ".jpg";
    a.click();
}

document.getElementById("downloadAllBtn").onclick = function() {
    if (!processedBlobs.length) return alert("请先处理图片");

    const zip = new JSZip();

    processedBlobs.forEach((blob, idx) => {
        zip.file("image_" + (idx+1) + ".jpg", blob);
    });

    zip.generateAsync({ type: "blob" }).then(content => {
        const a = document.createElement("a");
        a.href = URL.createObjectURL(content);
        a.download = "images.zip";
        a.click();
    });
};
</script>

</body>
</html>
