<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>图片压缩 & 格式转换（纯前端）</title>

    <style>
        body {
            margin: 0;
            padding: 0;
            font-family: "Segoe UI", sans-serif;
            color: white;
        }

        #content {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
            background: rgba(0,0,0,0.35);
            padding: 30px 50px;
            border-radius: 12px;
            backdrop-filter: blur(6px);
        }

        input, select, button {
            padding: 10px;
            margin: 10px 0;
            font-size: 16px;
        }

        button {
            cursor: pointer;
            border: none;
            background: #00c2ff;
            color: #000;
            border-radius: 6px;
            padding: 10px 20px;
        }

        button:hover {
            background: #00a8df;
        }
    </style>
</head>

<body>
    <!-- 背景容器 -->
    <div id="background"></div>

    <div id="content">
        <h2>图片压缩 & 格式转换</h2>

        <input type="file" id="inputFiles" multiple accept="image/*" /><br>

        <select id="targetFormat">
            <option value="original">保持原格式</option>
            <option value="image/jpeg">转 JPG</option>
            <option value="image/png">转 PNG</option>
            <option value="image/webp">转 WEBP</option>
        </select><br>

        <button onclick="compressAndDownload()">开始处理</button>
    </div>

    <!-- 必要的 JS 文件 -->
    <script src="./js/three.min.js"></script>
    <script src="./js/vanta.net.min.js"></script>

    <script src="./js/jszip.min.js"></script>
    <script src="./js/browser-image-compression.min.js"></script>

    <script>
        // 背景动画
        VANTA.NET({
            el: "#background",
            mouseControls: true,
            touchControls: true,
            gyroControls: false,
            minHeight: 200.00,
            minWidth: 200.00,
            scale: 1.00,
            scaleMobile: 1.00,
            color: 0x00ffff,
            backgroundColor: 0x000000,
        });

        // 图片压缩 + 转格式 + ZIP 下载
        async function compressAndDownload() {
            const files = document.getElementById("inputFiles").files;
            if (!files.length) {
                alert("请先选择图片");
                return;
            }

            const targetFormat = document.getElementById("targetFormat").value;
            const zip = new JSZip();

            for (let file of files) {
                const options = {
                    maxSizeMB: 1,
                    maxWidthOrHeight: 2000,
                    useWebWorker: true,
                    fileType: targetFormat === "original" ? file.type : targetFormat
                };

                const compressedFile = await imageCompression(file, options);
                const fileName = file.name.replace(/\.[^/.]+$/, "");
                const arrayBuffer = await compressedFile.arrayBuffer();

                const ext = targetFormat === "original"
                    ? file.name.split(".").pop()
                    : targetFormat.split("/")[1];

                zip.file(`${fileName}.${ext}`, arrayBuffer);
            }

            zip.generateAsync({ type: "blob" }).then(content => {
                const a = document.createElement("a");
                a.href = URL.createObjectURL(content);
                a.download = "compressed_images.zip";
                a.click();
            });
        }
    </script>
</body>
</html>
